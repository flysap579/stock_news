import requests
import pandas as pd
import schedule
import time

# 定義抓取台灣股市三大法人買賣金額統計表的函數
def fetch_taiwan_stock_data():
    url = 'https://www.twse.com.tw/fund/BFI82U?response=json&dayDate=&weekDate=&monthDate=&type=day'
    response = requests.get(url)

    if response.status_code == 200:
        data = response.json()
        if data['stat'] == 'OK':
            # 解析並格式化數據
            table_header = data['title']
            table_date = data['date']
            fields = data['fields']
            content = data['data']
            
            message = f"{table_header} - {table_date}\n\n"
            message += "\t".join(fields) + "\n"
            for row in content:
                message += "\t".join(row) + "\n"
            return message
        else:
            return "Failed to retrieve data. Status: Not OK"
    else:
        return f"Failed to retrieve data. Status code: {response.status_code}"

# 定義發送 LINE Notify 通知的函數
def send_line_notify(message, token):
    url = 'https://notify-api.line.me/api/notify'
    headers = {
        'Authorization': f'Bearer {token}'
    }
    data = {
        'message': message
    }
    response = requests.post(url, headers=headers, data=data)
    if response.status_code == 200:
        print('Notification sent successfully!')
    else:
        print(f'Failed to send notification. Status code: {response.status_code}')

# 您的 LINE Notify Access Token
access_token = 'YOUR_ACCESS_TOKEN_HERE'

# 定義每日發送通知的任務
def daily_task():
    stock_data = fetch_taiwan_stock_data()
    message = f"今日台灣股市三大法人買賣金額統計表：\n\n{stock_data}"
    send_line_notify(message, access_token)

# 安排每天的任務
schedule.every().day.at("18:00").do(daily_task)  # 設定每天18:00執行任務

# 開始執行排程
while True:
    schedule.run_pending()
    time.sleep(1)
